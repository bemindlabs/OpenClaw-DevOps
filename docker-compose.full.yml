version: '3.8'

# OpenClaw DevOps - Full Stack with Databases, Messaging, and Monitoring
# This extends the basic docker-compose.yml with additional services

services:
  # =============================================================================
  # CORE SERVICES (from original docker-compose.yml)
  # =============================================================================

  # OpenClaw Assistant - Admin Portal
  assistant:
    image: openclaw-assistant:latest
    container_name: openclaw-assistant
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${ASSISTANT_PORT:-5555}
      - HOSTNAME=0.0.0.0
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@localhost:${MONGODB_PORT:-27017}/${MONGO_DATABASE}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@localhost:${REDIS_PORT:-6379}
      - GATEWAY_URL=http://localhost:${GATEWAY_PORT:-18789}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-https://assistant.your-domain.com}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - ALLOWED_OAUTH_DOMAINS=${ALLOWED_OAUTH_DOMAINS}
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://127.0.0.1:5555/']
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 60s
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      gateway:
        condition: service_healthy

  nginx:
    image: nginx:alpine
    container_name: openclaw-nginx
    restart: unless-stopped
    network_mode: 'host'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - landing
      - gateway
      - assistant

  landing:
    image: openclaw-landing:latest
    container_name: openclaw-landing
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${LANDING_PORT:-3000}
      - HOSTNAME=0.0.0.0
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@localhost:${MONGODB_PORT:-27017}/${MONGO_DATABASE}
      - POSTGRES_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT:-5432}/${POSTGRES_DB}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@localhost:${REDIS_PORT:-6379}
      - GATEWAY_URL=http://localhost:${GATEWAY_PORT:-18789}
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://127.0.0.1:3000/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # OpenClaw Gateway
  gateway:
    image: openclaw-gateway:latest
    container_name: openclaw-gateway
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${GATEWAY_PORT:-18789}
      - HOSTNAME=0.0.0.0
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@localhost:${MONGODB_PORT:-27017}/${MONGO_DATABASE}
      - POSTGRES_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT:-5432}/${POSTGRES_DB}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@localhost:${REDIS_PORT:-6379}
      - KAFKA_BROKERS=localhost:${KAFKA_PORT:-9092}
      - N8N_WEBHOOK_URL=http://localhost:${N8N_PORT:-5678}
      # LLM Configuration
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_FALLBACK_PROVIDERS=${LLM_FALLBACK_PROVIDERS}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS}
      # LLM API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY}
      - MOONSHOT_BASE_URL=${MOONSHOT_BASE_URL}
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://127.0.0.1:18789/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # =============================================================================
  # DATABASES
  # =============================================================================

  # MongoDB
  mongodb:
    image: mongo:7
    container_name: openclaw-mongodb
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGO_DATABASE}
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    healthcheck:
      test: ['CMD', 'mongosh', '--quiet', '--eval', "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    command: ['mongod', '--bind_ip_all']

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: openclaw-postgres
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Redis
  redis:
    image: redis:7-alpine
    container_name: openclaw-redis
    restart: unless-stopped
    network_mode: 'host'
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # =============================================================================
  # MESSAGING & WORKFLOW
  # =============================================================================

  # Zookeeper (required for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: openclaw-zookeeper
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - ZOOKEEPER_CLIENT_PORT=${ZOOKEEPER_PORT:-2181}
      - ZOOKEEPER_TICK_TIME=2000
      - ZOOKEEPER_SYNC_LIMIT=2
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    healthcheck:
      test: ['CMD', 'echo', 'ruok', '|', 'nc', 'localhost', '2181']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: openclaw-kafka
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - KAFKA_BROKER_ID=${KAFKA_BROKER_ID:-1}
      - KAFKA_ZOOKEEPER_CONNECT=localhost:${ZOOKEEPER_PORT:-2181}
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:${KAFKA_PORT:-9092}
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - kafka-data:/var/lib/kafka/data
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'kafka-broker-api-versions', '--bootstrap-server', 'localhost:9092']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # n8n - Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: openclaw-n8n
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=localhost
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:${N8N_PORT:-5678}/
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=localhost
      - DB_POSTGRESDB_PORT=${POSTGRES_PORT:-5432}
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - n8n-data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5678/healthz']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # MONITORING & OBSERVABILITY
  # =============================================================================

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: openclaw-prometheus
    restart: unless-stopped
    network_mode: 'host'
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    environment:
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:9090/-/healthy']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Grafana - Metrics Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: openclaw-grafana
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=${GF_INSTALL_PLUGINS}
      - GF_SERVER_HTTP_PORT=${GRAFANA_PORT:-3001}
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - TZ=${TZ:-Asia/Bangkok}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3001/api/health']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Node Exporter - System Metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: openclaw-node-exporter
    restart: unless-stopped
    network_mode: 'host'
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /:/host:ro,rslave
    environment:
      - TZ=${TZ:-Asia/Bangkok}

  # cAdvisor - Container Metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: openclaw-cadvisor
    restart: unless-stopped
    network_mode: 'host'
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg
    # Security: Use specific capabilities instead of privileged mode
    cap_add:
      - SYS_ADMIN # Required for cgroup access
      - SYS_PTRACE # Required for process monitoring
    security_opt:
      - apparmor:unconfined # Required for cAdvisor to access cgroups
    environment:
      - TZ=${TZ:-Asia/Bangkok}

  # Redis Exporter - Redis Metrics
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: openclaw-redis-exporter
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - REDIS_ADDR=localhost:${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - TZ=${TZ:-Asia/Bangkok}
    depends_on:
      redis:
        condition: service_healthy

  # Postgres Exporter - PostgreSQL Metrics
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: openclaw-postgres-exporter
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - DATA_SOURCE_NAME=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT:-5432}/${POSTGRES_DB}?sslmode=disable
      - TZ=${TZ:-Asia/Bangkok}
    depends_on:
      postgres:
        condition: service_healthy

  # MongoDB Exporter - MongoDB Metrics
  mongodb-exporter:
    image: percona/mongodb_exporter:0.40
    container_name: openclaw-mongodb-exporter
    restart: unless-stopped
    network_mode: 'host'
    environment:
      - MONGODB_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@localhost:${MONGODB_PORT:-27017}
      - TZ=${TZ:-Asia/Bangkok}
    depends_on:
      mongodb:
        condition: service_healthy

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  # Original volumes
  nginx-logs:
    driver: local

  # Database volumes
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local

  # Messaging volumes
  zookeeper-data:
    driver: local
  zookeeper-logs:
    driver: local
  kafka-data:
    driver: local

  # Workflow volumes
  n8n-data:
    driver: local

  # Monitoring volumes
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================
# Note: Using host network mode for all services
# This allows services to communicate via localhost
