#!/bin/bash
# Agent Coordinator - Configurable Multi-Agent Task Management
# Usage: agent-coordinator.sh <action> [options] [epic]

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Configuration paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="$(dirname "$SCRIPT_DIR")/config"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

# Default configuration
CONFIG_FILE="${CONFIG_FILE:-$CONFIG_DIR/agents.yaml}"
SOLUTIONS_DIR="${SOLUTIONS_DIR:-$HOME/Solutions}"
EPICS_DIR="${EPICS_DIR:-$SOLUTIONS_DIR/.epics}"
SESSIONS_FILE="${SESSIONS_FILE:-$HOME/.claude/agent-sessions.json}"

# Parse configuration (using python for YAML parsing)
parse_config() {
    python3 << PYTHON
import yaml
import json
import os

config_file = os.environ.get('CONFIG_FILE', '$CONFIG_FILE')

try:
    with open(config_file, 'r') as f:
        config = yaml.safe_load(f)
    print(json.dumps(config))
except Exception as e:
    print(json.dumps({"error": str(e)}))
PYTHON
}

# Slug generator
generate_slug() {
    echo "$1" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-' | cut -c1-50
}

# Create epic directory structure
create_epic_directory() {
    local epic="$1"
    local epic_slug=$(generate_slug "$epic")
    local timestamp=$(date +%s)
    local date_prefix=$(date +%Y-%m-%d)
    local session_id="epic-${epic_slug}-${timestamp}"
    local epic_dir="$EPICS_DIR/${date_prefix}-${epic_slug}"

    echo -e "${BLUE}Creating epic directory...${NC}"

    # Create directory structure
    mkdir -p "$epic_dir"/{research,planning,implementation,review,docs,logs}
    mkdir -p "$epic_dir"/agents/{gemini,codex,claude,custom}

    # Create README
    cat > "$epic_dir/README.md" << EOF
---
title: ${epic}
created: $(date -Iseconds)
session_id: ${session_id}
status: in_progress
tags: [epic, ${epic_slug}]
---

# Epic: ${epic}

**Created:** $(date)
**Session ID:** ${session_id}
**Status:** ðŸŸ¡ In Progress

## Overview

${epic}

## Directory Structure

\`\`\`
${epic_dir}/
â”œâ”€â”€ research/           # Codebase analysis and best practices
â”œâ”€â”€ planning/           # Architecture and task planning
â”œâ”€â”€ implementation/     # Code changes and patches
â”œâ”€â”€ review/             # QA and verification reports
â”œâ”€â”€ docs/               # Documentation
â”œâ”€â”€ logs/               # Execution logs
â””â”€â”€ agents/             # External agent workspaces
    â”œâ”€â”€ gemini/
    â”œâ”€â”€ codex/
    â”œâ”€â”€ claude/
    â””â”€â”€ custom/
\`\`\`

## Agents Deployed

| Agent | Type | Status | Output |
|-------|------|--------|--------|
| explore | Internal | ðŸ”„ Pending | research/codebase-analysis.json |
| plan | Internal | ðŸ”„ Pending | planning/plan.md |
| research | Internal | ðŸ”„ Pending | research/best-practices.json |
| gemini | External | ðŸ”„ Pending | agents/gemini/research.json |
| codex | External | ðŸ”„ Pending | agents/codex/analysis.json |

## Generated Files

*Will be updated as agents complete*

## Notes

---

*Auto-generated by Agent Coordinator*
EOF

    # Create tasks.json template
    cat > "$epic_dir/planning/tasks.json" << EOF
{
  "epic": "${epic}",
  "session_id": "${session_id}",
  "created": "$(date -Iseconds)",
  "status": "pending",
  "tasks": []
}
EOF

    echo "$epic_dir"
}

# Create tmux session
create_tmux_session() {
    local session_id="$1"
    local epic_dir="$2"

    echo -e "${BLUE}Creating tmux session: ${session_id}${NC}"

    # Create main session
    tmux new-session -d -s "$session_id" -n "coordinator" -c "$epic_dir"

    # Create windows for each external agent
    tmux new-window -t "$session_id" -n "gemini" -c "$epic_dir/agents/gemini"
    tmux new-window -t "$session_id" -n "codex" -c "$epic_dir/agents/codex"
    tmux new-window -t "$session_id" -n "claude" -c "$epic_dir/agents/claude"

    # Return to coordinator window
    tmux select-window -t "$session_id:coordinator"

    echo -e "${GREEN}âœ“${NC} Tmux session created: ${session_id}"
}

# Spawn external agents
spawn_external_agents() {
    local session_id="$1"
    local epic="$2"
    local epic_dir="$3"

    echo -e "${BLUE}Spawning external agents...${NC}"

    # Load prompts and send to external CLIs
    local gemini_prompt=$(cat "$CONFIG_DIR/prompts/gemini.md" 2>/dev/null | \
        sed "s|{{EPIC}}|$epic|g" | \
        sed "s|{{EPIC_DIR}}|$epic_dir|g" | \
        sed "s|{{OUTPUT_FILE}}|research.json|g")

    local codex_prompt=$(cat "$CONFIG_DIR/prompts/codex.md" 2>/dev/null | \
        sed "s|{{EPIC}}|$epic|g" | \
        sed "s|{{EPIC_DIR}}|$epic_dir|g" | \
        sed "s|{{PROJECT_DIR}}|$(pwd)|g" | \
        sed "s|{{OUTPUT_FILE}}|analysis.json|g")

    # Gemini agent
    if command -v gemini &> /dev/null; then
        tmux send-keys -t "$session_id:gemini" "gemini -p '$gemini_prompt' 2>&1 | tee output.log; echo 'AGENT_COMPLETE' >> output.log" Enter
        echo -e "${GREEN}âœ“${NC} Gemini agent spawned"
    else
        echo -e "${YELLOW}âš ${NC} Gemini CLI not found, skipping"
        echo "Gemini CLI not available" > "$epic_dir/agents/gemini/output.log"
    fi

    # Codex agent
    if command -v codex &> /dev/null; then
        tmux send-keys -t "$session_id:codex" "codex -p '$codex_prompt' 2>&1 | tee output.log; echo 'AGENT_COMPLETE' >> output.log" Enter
        echo -e "${GREEN}âœ“${NC} Codex agent spawned"
    else
        echo -e "${YELLOW}âš ${NC} Codex CLI not found, skipping"
        echo "Codex CLI not available" > "$epic_dir/agents/codex/output.log"
    fi
}

# Track session
track_session() {
    local session_id="$1"
    local epic="$2"
    local epic_dir="$3"

    # Ensure sessions directory exists
    mkdir -p "$(dirname "$SESSIONS_FILE")"

    python3 << PYTHON
import json
import os
from datetime import datetime

sessions_file = "$SESSIONS_FILE"

# Load existing sessions
if os.path.exists(sessions_file):
    with open(sessions_file, 'r') as f:
        try:
            data = json.load(f)
        except:
            data = {"sessions": []}
else:
    data = {"sessions": []}

# Add new session
new_session = {
    "id": "$session_id",
    "type": "coding",
    "epic": "$epic",
    "epic_dir": "$epic_dir",
    "status": "running",
    "created": datetime.now().isoformat(),
    "agents": {
        "internal": [],
        "external": ["gemini", "codex", "claude"]
    },
    "tmux_session": "$session_id"
}

data["sessions"].append(new_session)

with open(sessions_file, 'w') as f:
    json.dump(data, f, indent=2)

print(f"Session tracked: $session_id")
PYTHON
}

# Run action
action_run() {
    local epic="$1"

    if [ -z "$epic" ]; then
        echo -e "${RED}Error: No epic/task specified${NC}"
        echo "Usage: agent-coordinator.sh run <epic description>"
        exit 1
    fi

    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘  Agent Coordinator - Starting Epic         â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}Epic:${NC} $epic"
    echo ""

    # Create epic directory
    local epic_dir=$(create_epic_directory "$epic")
    local epic_slug=$(generate_slug "$epic")
    local session_id="epic-${epic_slug}-$(date +%s)"

    echo -e "${GREEN}âœ“${NC} Epic directory: $epic_dir"
    echo ""

    # Create tmux session
    create_tmux_session "$session_id" "$epic_dir"
    echo ""

    # Spawn external agents
    spawn_external_agents "$session_id" "$epic" "$epic_dir"
    echo ""

    # Track session
    track_session "$session_id" "$epic" "$epic_dir"
    echo ""

    # Display summary
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘  Epic Started Successfully                 â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}Session ID:${NC} $session_id"
    echo -e "${CYAN}Epic Dir:${NC}   $epic_dir"
    echo ""
    echo -e "${YELLOW}Next Steps:${NC}"
    echo "1. Spawn internal agents via Claude Task tool"
    echo "2. Check status: agent-coordinator.sh status"
    echo "3. Attach to tmux: agent-coordinator.sh attach"
    echo "4. Complete: agent-coordinator.sh complete"
    echo ""
    echo -e "${CYAN}Tmux Commands:${NC}"
    echo "  tmux attach -t $session_id"
    echo "  Ctrl+b 0-3 to switch windows"
    echo "  Ctrl+b d to detach"
}

# Status action
action_status() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘  Agent Coordinator Status                  â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # Recent epics
    echo -e "${CYAN}Recent Epics:${NC}"
    if [ -d "$EPICS_DIR" ]; then
        ls -lt "$EPICS_DIR" 2>/dev/null | head -5 | tail -4
    else
        echo "  No epics found"
    fi
    echo ""

    # Active tmux sessions
    echo -e "${CYAN}Active Tmux Sessions:${NC}"
    tmux list-sessions 2>/dev/null | grep -E "^epic-" || echo "  No active epic sessions"
    echo ""

    # Agent outputs
    if [ -f "$SESSIONS_FILE" ]; then
        echo -e "${CYAN}Session Details:${NC}"
        python3 << PYTHON
import json
import os

with open("$SESSIONS_FILE", 'r') as f:
    data = json.load(f)

for session in data.get('sessions', []):
    if session.get('status') == 'running':
        print(f"  Session: {session.get('id')}")
        print(f"  Epic: {session.get('epic')}")
        print(f"  Directory: {session.get('epic_dir')}")

        epic_dir = session.get('epic_dir', '')
        if os.path.exists(epic_dir):
            print("  Agent Outputs:")
            for agent in ['gemini', 'codex', 'claude']:
                log_path = f"{epic_dir}/agents/{agent}/output.log"
                if os.path.exists(log_path):
                    with open(log_path) as f:
                        lines = len(f.readlines())
                    status = "âœ“ Complete" if lines > 0 else "â³ Running"
                    print(f"    - {agent}: {status} ({lines} lines)")
                else:
                    print(f"    - {agent}: â³ Pending")
        print("")
PYTHON
    fi
}

# Attach action
action_attach() {
    local session=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^epic-" | head -1)

    if [ -z "$session" ]; then
        echo -e "${YELLOW}No active epic sessions found${NC}"
        exit 1
    fi

    echo -e "${BLUE}Attaching to: ${session}${NC}"
    echo "Windows: coordinator(0), gemini(1), codex(2), claude(3)"
    echo "Use Ctrl+b then 0-3 to switch, Ctrl+b d to detach"
    echo ""

    tmux attach -t "$session"
}

# Complete action
action_complete() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘  Completing Epic                           â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # Find current session
    local session=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^epic-" | head -1)

    if [ -z "$session" ]; then
        echo -e "${YELLOW}No active epic sessions found${NC}"
        exit 1
    fi

    # Get epic directory from session file
    local epic_dir=$(python3 << PYTHON
import json
with open("$SESSIONS_FILE") as f:
    data = json.load(f)
for s in data.get('sessions', []):
    if s.get('status') == 'running':
        print(s.get('epic_dir', ''))
        break
PYTHON
)

    if [ -z "$epic_dir" ] || [ ! -d "$epic_dir" ]; then
        echo -e "${RED}Could not find epic directory${NC}"
        exit 1
    fi

    echo -e "${CYAN}Epic Directory:${NC} $epic_dir"
    echo ""

    # Generate summary
    echo -e "${YELLOW}Generating summary...${NC}"

    cat > "$epic_dir/review/agent-summary.md" << EOF
---
title: Agent Work Summary
generated: $(date -Iseconds)
---

# Agent Work Summary

## Session Information
- **Session ID:** $session
- **Epic Directory:** $epic_dir
- **Completed:** $(date)

## External Agent Outputs

### Gemini (Web Research)
\`\`\`
$(head -50 "$epic_dir/agents/gemini/output.log" 2>/dev/null || echo "No output")
\`\`\`

### Codex (Code Analysis)
\`\`\`
$(head -50 "$epic_dir/agents/codex/output.log" 2>/dev/null || echo "No output")
\`\`\`

### Claude (Verification)
\`\`\`
$(head -50 "$epic_dir/agents/claude/output.log" 2>/dev/null || echo "No output")
\`\`\`

## Files Generated

\`\`\`
$(find "$epic_dir" -type f -name "*.json" -o -name "*.md" | grep -v README.md | sort)
\`\`\`

## Next Steps

1. Review agent outputs
2. Consolidate findings
3. Begin implementation

---
*Generated by Agent Coordinator*
EOF

    echo -e "${GREEN}âœ“${NC} Summary saved to: $epic_dir/review/agent-summary.md"

    # Update session status
    python3 << PYTHON
import json
from datetime import datetime

with open("$SESSIONS_FILE") as f:
    data = json.load(f)

for s in data['sessions']:
    if s.get('id') == '$session':
        s['status'] = 'completed'
        s['completed'] = datetime.now().isoformat()

with open("$SESSIONS_FILE", 'w') as f:
    json.dump(data, f, indent=2)
PYTHON

    echo -e "${GREEN}âœ“${NC} Session marked as completed"
    echo ""

    # Optionally kill tmux session
    read -p "Kill tmux session? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        tmux kill-session -t "$session"
        echo -e "${GREEN}âœ“${NC} Tmux session killed"
    fi
}

# Stop action
action_stop() {
    echo -e "${YELLOW}Stopping all epic sessions...${NC}"

    for session in $(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^epic-"); do
        echo "Killing: $session"
        tmux kill-session -t "$session"
    done

    echo -e "${GREEN}âœ“${NC} All epic sessions stopped"
}

# Help
show_help() {
    echo "Agent Coordinator - Multi-Agent Task Management"
    echo ""
    echo "Usage: agent-coordinator.sh <action> [options]"
    echo ""
    echo "Actions:"
    echo "  run <epic>      Start a new epic with multi-agent coordination"
    echo "  status          Check status of running agents"
    echo "  complete        Complete epic and generate summary"
    echo "  attach          Attach to tmux session"
    echo "  stop            Stop all running sessions"
    echo "  help            Show this help"
    echo ""
    echo "Configuration:"
    echo "  CONFIG_FILE     Path to agents.yaml (default: $CONFIG_FILE)"
    echo "  SOLUTIONS_DIR   Solutions directory (default: $SOLUTIONS_DIR)"
    echo "  EPICS_DIR       Epics directory (default: $EPICS_DIR)"
    echo ""
    echo "Examples:"
    echo "  agent-coordinator.sh run 'Implement user authentication'"
    echo "  agent-coordinator.sh status"
    echo "  agent-coordinator.sh attach"
    echo "  agent-coordinator.sh complete"
}

# Main
main() {
    local action="${1:-help}"
    shift || true

    case "$action" in
        run)
            action_run "$*"
            ;;
        status)
            action_status
            ;;
        attach)
            action_attach
            ;;
        complete)
            action_complete
            ;;
        stop)
            action_stop
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            # Default: treat as epic description
            action_run "$action $*"
            ;;
    esac
}

main "$@"
