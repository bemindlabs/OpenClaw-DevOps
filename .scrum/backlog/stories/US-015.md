# US-015: Google OAuth Integration

## Story Details

| Field | Value |
|-------|-------|
| **Story ID** | US-015 |
| **Epic** | EPIC-ADMIN |
| **Title** | Google OAuth Integration |
| **Priority** | Critical |
| **Story Points** | 5 |
| **Status** | Ready |
| **Assignee** | Unassigned |
| **Sprint** | Sprint 1 |

## User Story

**As an** administrator,
**I want** to log in using my Google account,
**So that** I can securely access the admin dashboard without managing separate credentials.

## Description

Implement Google OAuth 2.0 authentication for the Admin Dashboard using NextAuth.js. Restrict access to approved email domains and implement session management with JWT tokens.

## Acceptance Criteria

- [ ] Google OAuth login button on login page
- [ ] Successful OAuth redirects to dashboard
- [ ] Only approved email domains can log in
- [ ] Unauthorized domains see clear error message
- [ ] Session persists across page refreshes
- [ ] Session expires after configured timeout
- [ ] User can log out and session is cleared
- [ ] User profile (name, email, avatar) displayed in UI
- [ ] Secure cookie settings (httpOnly, secure, sameSite)
- [ ] CSRF protection enabled

## Technical Notes

### IEEE Requirement References
- IEEE-STD-ADMIN-001: Authentication

### NextAuth.js Configuration

```typescript
// lib/auth.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const ALLOWED_DOMAINS = (process.env.ALLOWED_OAUTH_DOMAINS || '')
  .split(',')
  .map(d => d.trim())
  .filter(Boolean);

export const authOptions: NextAuthOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
  ],

  callbacks: {
    async signIn({ user, account, profile }) {
      // Check if email domain is allowed
      const email = user.email || '';
      const domain = email.split('@')[1];

      if (ALLOWED_DOMAINS.length > 0 && !ALLOWED_DOMAINS.includes(domain)) {
        return false; // Reject login
      }

      return true;
    },

    async session({ session, token }) {
      // Add custom data to session
      if (session.user) {
        session.user.id = token.sub!;
        session.user.role = await getUserRole(token.email);
      }
      return session;
    },

    async jwt({ token, user, account }) {
      if (account && user) {
        token.accessToken = account.access_token;
      }
      return token;
    },
  },

  pages: {
    signIn: '/login',
    error: '/login',
  },

  session: {
    strategy: 'jwt',
    maxAge: 24 * 60 * 60, // 24 hours
  },
};

export const { handlers, auth, signIn, signOut } = NextAuth(authOptions);
```

### Auth Route Handler

```typescript
// app/api/auth/[...nextauth]/route.ts
import { handlers } from '@/lib/auth';

export const { GET, POST } = handlers;
```

### Login Page

```tsx
// app/login/page.tsx
import { signIn, auth } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function LoginPage() {
  const session = await auth();

  if (session) {
    redirect('/dashboard');
  }

  return (
    <div className="min-h-screen flex items-center justify-center">
      <Card className="w-full max-w-md p-8">
        <h1 className="text-2xl font-bold text-center mb-6">
          Admin Dashboard
        </h1>
        <form action={async () => {
          'use server';
          await signIn('google', { redirectTo: '/dashboard' });
        }}>
          <Button type="submit" className="w-full" size="lg">
            <GoogleIcon className="mr-2 h-5 w-5" />
            Sign in with Google
          </Button>
        </form>
        <p className="text-sm text-muted-foreground text-center mt-4">
          Only authorized email domains can access this dashboard.
        </p>
      </Card>
    </div>
  );
}
```

### Middleware Protection

```typescript
// middleware.ts
import { auth } from '@/lib/auth';
import { NextResponse } from 'next/server';

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isOnDashboard = req.nextUrl.pathname.startsWith('/dashboard');

  if (isOnDashboard && !isLoggedIn) {
    return NextResponse.redirect(new URL('/login', req.url));
  }

  return NextResponse.next();
});

export const config = {
  matcher: ['/dashboard/:path*'],
};
```

### Environment Variables

```env
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
NEXTAUTH_URL=https://assistant.your-domain.com
NEXTAUTH_SECRET=your-secret-key-min-32-chars
ALLOWED_OAUTH_DOMAINS=yourcompany.com,partner.com
```

### Files to Create/Modify
- `apps/assistant/lib/auth.ts`
- `apps/assistant/app/api/auth/[...nextauth]/route.ts`
- `apps/assistant/app/login/page.tsx`
- `apps/assistant/middleware.ts`
- `apps/assistant/types/next-auth.d.ts`

## Dependencies

- NextAuth.js v5 installed
- Google Cloud Console project configured
- OAuth consent screen set up
- Environment variables configured

## Definition of Done

- [ ] Google OAuth login works
- [ ] Domain restriction enforced
- [ ] Session management working
- [ ] Logout clears session
- [ ] User info displayed in header
- [ ] Protected routes redirect to login
- [ ] Error handling for OAuth failures
- [ ] Documentation for OAuth setup

---

*Created: 2026-02-08*
