# US-004: CI/CD Pipeline with GitHub Actions

## Story Details

| Field | Value |
|-------|-------|
| **Story ID** | US-004 |
| **Epic** | EPIC-INFRA |
| **Title** | CI/CD Pipeline with GitHub Actions |
| **Priority** | High |
| **Story Points** | 8 |
| **Status** | Ready |
| **Assignee** | Unassigned |
| **Sprint** | Sprint 1 |

## User Story

**As a** developer,
**I want** an automated CI/CD pipeline,
**So that** code changes are automatically tested, security-scanned, and deployed to the appropriate environment.

## Description

Implement GitHub Actions workflows for continuous integration and continuous deployment. The pipeline should include linting, type checking, building, testing, security scanning (Trivy, Semgrep), and deployment automation for both staging and production environments.

## Acceptance Criteria

- [ ] PR workflow runs on all pull requests to `main` and `develop`
- [ ] Linting (ESLint) runs and blocks merge on failure
- [ ] TypeScript type checking runs and blocks on errors
- [ ] All apps build successfully (`pnpm build:all`)
- [ ] Security scanning with Trivy and Semgrep
- [ ] Docker images built and tagged correctly
- [ ] Deployment triggered on merge to `main`
- [ ] Deployment status reported back to GitHub
- [ ] Secrets stored securely in GitHub Secrets
- [ ] Build cache configured for faster runs

## Technical Notes

### IEEE Requirement References
- IEEE-STD-INFRA-003: Security Standards

### Workflow Structure

```
.github/workflows/
  pr-checks.yml       # Runs on PRs
  deploy.yml          # Runs on merge to main
  security.yml        # Security scanning
```

### PR Checks Workflow

```yaml
name: PR Checks
on:
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
      - uses: actions/setup-node@v4
      - run: pnpm install
      - run: pnpm lint:all

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - run: pnpm typecheck

  build:
    runs-on: ubuntu-latest
    steps:
      - run: pnpm build:all

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: aquasecurity/trivy-action@master
```

### Deployment Workflow

```yaml
name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GCE
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCE_HOST }}
          username: ${{ secrets.GCE_USER }}
          key: ${{ secrets.GCE_SSH_KEY }}
          script: |
            cd /opt/openclaw
            ./deployments/gce/deploy.sh
```

### Required GitHub Secrets

```
GCE_HOST           # Server IP address
GCE_USER           # SSH username
GCE_SSH_KEY        # SSH private key
DOCKER_USERNAME    # Docker Hub username (optional)
DOCKER_PASSWORD    # Docker Hub password (optional)
```

### Build Caching

```yaml
- uses: actions/cache@v4
  with:
    path: |
      ~/.pnpm-store
      **/node_modules
    key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
```

### Files to Create/Modify
- `.github/workflows/pr-checks.yml`
- `.github/workflows/deploy.yml`
- `.github/workflows/security.yml`

## Dependencies

- GitHub repository configured
- GCE instance provisioned (for deployment)
- Docker Hub account (optional)

## Definition of Done

- [ ] All workflows created and tested
- [ ] PR checks run on sample PR
- [ ] Deployment runs on merge to main
- [ ] Security scan results visible in PR
- [ ] Documentation updated
- [ ] Team trained on pipeline usage

---

*Created: 2026-02-08*
