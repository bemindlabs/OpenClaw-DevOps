# US-020: Grafana Dashboards

## Story Details

| Field | Value |
|-------|-------|
| **Story ID** | US-020 |
| **Epic** | EPIC-MONITORING |
| **Title** | Grafana Dashboards |
| **Priority** | High |
| **Story Points** | 8 |
| **Status** | Ready |
| **Assignee** | Unassigned |
| **Sprint** | Sprint 3 |

## User Story

**As an** operator,
**I want** Grafana dashboards for monitoring the platform,
**So that** I can visualize system health, performance, and usage patterns.

## Description

Create comprehensive Grafana dashboards for monitoring all aspects of the OpenClaw platform. Include dashboards for overview, infrastructure, application services, databases, and LLM analytics. Set up data sources and provisioning for reproducible deployments.

## Acceptance Criteria

- [ ] Prometheus data source configured
- [ ] Overview dashboard with system health summary
- [ ] Infrastructure dashboard (CPU, memory, disk, network)
- [ ] Application dashboard (requests, latency, errors)
- [ ] Database dashboard (connections, queries, storage)
- [ ] LLM analytics dashboard (provider usage, tokens, costs)
- [ ] All dashboards auto-provisioned on startup
- [ ] Time range selector on all dashboards
- [ ] Auto-refresh configured (30s default)
- [ ] Responsive layouts for different screen sizes
- [ ] Authentication required (admin credentials)

## Technical Notes

### IEEE Requirement References
- IEEE-STD-MON-002: Dashboard Standards

### Dashboard Structure

```
monitoring/grafana/
  provisioning/
    dashboards/
      default.yaml        # Dashboard provisioner config
    datasources/
      prometheus.yaml     # Prometheus data source
  dashboards/
    overview.json         # System overview
    infrastructure.json   # Node/container metrics
    applications.json     # Service metrics
    databases.json        # Database metrics
    llm-analytics.json    # LLM usage and costs
```

### Data Source Provisioning

```yaml
# monitoring/grafana/provisioning/datasources/prometheus.yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://localhost:9090
    isDefault: true
    editable: false
    jsonData:
      timeInterval: '15s'
```

### Dashboard Provisioning

```yaml
# monitoring/grafana/provisioning/dashboards/default.yaml
apiVersion: 1

providers:
  - name: 'OpenClaw Dashboards'
    orgId: 1
    folder: 'OpenClaw'
    folderUid: 'openclaw'
    type: file
    disableDeletion: false
    editable: true
    options:
      path: /var/lib/grafana/dashboards
```

### Overview Dashboard Panels

```json
// Overview dashboard structure
{
  "title": "OpenClaw Overview",
  "panels": [
    {
      "title": "Service Status",
      "type": "stat",
      "gridPos": { "h": 4, "w": 8 },
      "targets": [
        { "expr": "up{job=~\"gateway|landing|assistant\"}" }
      ]
    },
    {
      "title": "Request Rate",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12 },
      "targets": [
        { "expr": "sum(rate(http_requests_total[5m])) by (job)" }
      ]
    },
    {
      "title": "Error Rate",
      "type": "gauge",
      "gridPos": { "h": 4, "w": 4 },
      "targets": [
        { "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m]))" }
      ]
    },
    {
      "title": "P95 Latency",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4 },
      "targets": [
        { "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))" }
      ]
    }
  ]
}
```

### Infrastructure Dashboard Panels

```json
// Key panels
{
  "panels": [
    {
      "title": "CPU Usage",
      "type": "timeseries",
      "targets": [
        { "expr": "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)" }
      ]
    },
    {
      "title": "Memory Usage",
      "type": "timeseries",
      "targets": [
        { "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100" }
      ]
    },
    {
      "title": "Disk Usage",
      "type": "bargauge",
      "targets": [
        { "expr": "(1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100" }
      ]
    },
    {
      "title": "Container CPU",
      "type": "timeseries",
      "targets": [
        { "expr": "sum(rate(container_cpu_usage_seconds_total[5m])) by (name)" }
      ]
    }
  ]
}
```

### LLM Analytics Dashboard

```json
// LLM-specific panels
{
  "panels": [
    {
      "title": "Requests by Provider",
      "type": "piechart",
      "targets": [
        { "expr": "sum(llm_requests_total) by (provider)" }
      ]
    },
    {
      "title": "Token Usage",
      "type": "timeseries",
      "targets": [
        { "expr": "sum(rate(llm_tokens_total[1h])) by (provider, type)" }
      ]
    },
    {
      "title": "Estimated Costs",
      "type": "stat",
      "targets": [
        { "expr": "sum(llm_cost_dollars_total)" }
      ]
    },
    {
      "title": "Provider Latency",
      "type": "heatmap",
      "targets": [
        { "expr": "sum(rate(llm_request_duration_seconds_bucket[5m])) by (le, provider)" }
      ]
    },
    {
      "title": "Error Rate by Provider",
      "type": "timeseries",
      "targets": [
        { "expr": "sum(rate(llm_errors_total[5m])) by (provider)" }
      ]
    }
  ]
}
```

### Grafana Environment Configuration

```yaml
# In docker-compose.full.yml
grafana:
  environment:
    - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
    - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
    - GF_SERVER_HTTP_PORT=3001
    - GF_AUTH_ANONYMOUS_ENABLED=false
    - GF_USERS_ALLOW_SIGN_UP=false
    - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-clock-panel
```

### Files to Create/Modify
- `monitoring/grafana/provisioning/datasources/prometheus.yaml`
- `monitoring/grafana/provisioning/dashboards/default.yaml`
- `monitoring/grafana/dashboards/overview.json`
- `monitoring/grafana/dashboards/infrastructure.json`
- `monitoring/grafana/dashboards/applications.json`
- `monitoring/grafana/dashboards/databases.json`
- `monitoring/grafana/dashboards/llm-analytics.json`

## Dependencies

- Prometheus configured and running (US-019)
- All metrics being collected

## Definition of Done

- [ ] All dashboards created and visible
- [ ] Data displays correctly from Prometheus
- [ ] Time range selector works
- [ ] Auto-refresh working
- [ ] Authentication enforced
- [ ] Dashboards documented
- [ ] Export/import tested for portability

---

*Created: 2026-02-08*
