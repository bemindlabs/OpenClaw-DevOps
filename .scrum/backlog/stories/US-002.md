# US-002: Nginx Reverse Proxy Setup

## Story Details

| Field | Value |
|-------|-------|
| **Story ID** | US-002 |
| **Epic** | EPIC-INFRA |
| **Title** | Nginx Reverse Proxy Setup |
| **Priority** | Critical |
| **Story Points** | 3 |
| **Status** | Ready |
| **Assignee** | Unassigned |
| **Sprint** | Sprint 1 |

## User Story

**As a** system administrator,
**I want** Nginx configured as a reverse proxy,
**So that** all services are accessible through a single entry point with proper routing based on subdomain.

## Description

Configure Nginx as the primary reverse proxy for the OpenClaw platform. Implement subdomain-based routing to direct traffic to the appropriate backend services, with rate limiting, WebSocket support, and health check endpoints.

## Acceptance Criteria

- [ ] Main domain routes to Landing page (port 3000)
- [ ] `openclaw.` subdomain routes to Gateway (port 18789)
- [ ] `assistant.` subdomain routes to Assistant portal (port 5555)
- [ ] Rate limiting configured: 100 req/min for landing, 60 req/min for gateway
- [ ] WebSocket upgrade headers configured for all services
- [ ] `/health` endpoint returns 200 OK for all virtual hosts
- [ ] Proper proxy headers set (X-Real-IP, X-Forwarded-For, Host)
- [ ] Connection timeouts configured appropriately
- [ ] Configuration passes `nginx -t` validation

## Technical Notes

### IEEE Requirement References
- IEEE-STD-INFRA-002: Reverse Proxy Configuration

### Configuration Structure

```
nginx/
  nginx.conf          # Main nginx configuration
  conf.d/
    landing.conf      # your-domain.com -> landing:3000
    openclaw.conf     # openclaw.your-domain.com -> gateway:18789
    assistant.conf    # assistant.your-domain.com -> assistant:5555
```

### Rate Limiting Configuration

```nginx
# In nginx.conf
limit_req_zone $binary_remote_addr zone=landing:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=gateway:10m rate=60r/m;
```

### WebSocket Configuration

```nginx
# In upstream location blocks
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

### Health Check Endpoint

```nginx
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}
```

### Files to Create/Modify
- `nginx/nginx.conf`
- `nginx/conf.d/landing.conf`
- `nginx/conf.d/openclaw.conf`
- `nginx/conf.d/assistant.conf`

## Dependencies

- Docker Compose basic stack (US-001)
- Backend services running and accessible

## Definition of Done

- [ ] All configuration files created
- [ ] `nginx -t` passes without errors
- [ ] All routes tested and working
- [ ] Rate limiting verified
- [ ] WebSocket connections tested
- [ ] Documentation updated

---

*Created: 2026-02-08*
